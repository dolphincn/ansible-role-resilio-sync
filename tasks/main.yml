---
- name: Creating resilio-sync yum repository
  tags: rslsync
  become: true
  yum_repository:
    baseurl: "http://linux-packages.resilio.com/resilio-sync/rpm/$basearch"
    description: "Resilio Sync $basearch"
    enabled: yes
    gpgkey: "file:///etc/pki/rpm-gpg/RPM-GPG-KEY-resilio-sync"
    gpgcheck: yes
    name: resilio-sync
    state: present
  register: rslsync_yum_repository

- name: Downloading the resilio-sync gpg key to store locally
  tags: rslsync
  become: true
  get_url:
    url: "https://linux-packages.resilio.com/resilio-sync/key.asc"
    dest: "/etc/pki/rpm-gpg/RPM-GPG-KEY-resilio-sync"
    owner: root
    group: root
    mode: 0644
  register: rslsync_get_url

- name: Ensure that the resilio-sync gpg key is installed
  tags: rslsync
  become: true
  rpm_key:
    key: "/etc/pki/rpm-gpg/RPM-GPG-KEY-resilio-sync"
    state: present
  register: rslsync_rpm_key

- name: Ensure that the resilio-sync package is installed
  tags: rslsync
  become: true
  yum:
   enablerepo: resilio-sync
   name: resilio-sync
   state: present
   update_cache: yes
  register: rslsync_yum
  when:
    - rslsync_get_url|success
    - rslsync_rpm_key|success
    - rslsync_yum_repository|success

- block:
    - name: Applying config.json configuration
      template:
        src: config.json.j2
        dest: /etc/resilio-sync/config.json
        owner: root
        group: root
        mode: 0644
      notify: restart resilio-sync 

    - name: Creating hidden sync directories (if applicable)
      file:
        path: "{{ item.dir }}/.sync"
        owner: rslsync
        group: rslsync
        mode: 0775
        state: directory
      with_items: "{{ rslsync_shared_folders }}"
      when: item.dir is defined

    - name: Enable and start the resilio-sync service on boot
      service:
        enabled: yes
        name: resilio-sync
        state: started
  tags: rslsync
  become: true
  when: rslsync_yum|success
...
